# Dockerfile template for a Node/Nx API app
# Copy to e.g. apps/api/Dockerfile and adjust paths, workspace names, and build steps.
# Requires: package.json, package-lock.json, app package at apps/<api>/ and any shared packages.

ARG NODE_VERSION=22

FROM node:${NODE_VERSION}-slim AS base
WORKDIR /repo
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*
RUN corepack enable || true

# Dependencies (dev for build, prod for runtime)
FROM base AS deps-dev
COPY package.json package-lock.json ./
COPY apps/api/package.json apps/api/package.json
RUN npm ci --workspaces --include-workspace-root --ignore-scripts

FROM base AS deps-prod
COPY package.json package-lock.json ./
COPY apps/api/package.json apps/api/package.json
RUN npm ci --workspaces --include-workspace-root --only=production --ignore-scripts

# Build
FROM base AS build
WORKDIR /repo
COPY --from=deps-dev /repo/node_modules ./node_modules
COPY . .
ENV NX_DAEMON=false
RUN npx nx reset || true
# App-specific: generate types, run build (adjust project name)
RUN npx nx build api --configuration=production

# Production runtime
FROM node:${NODE_VERSION}-slim AS production
ENV NODE_ENV=production
WORKDIR /app
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*
COPY --from=build /repo/apps/api/dist ./apps/api/dist
COPY --from=deps-prod /repo/node_modules ./node_modules
EXPOSE 3000
CMD ["node", "apps/api/dist/index.js"]
